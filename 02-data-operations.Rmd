
# Data operations {#Data-operations}    

The [`SummarizedExperiment`](https://bioconductor.org/packages/release/bioc/html/SummarizedExperiment.html) (`SE`) is a widely used class for analyzing data obtained by common sequencing techniques. `SE` is common structure for several Bioconductor packages that are used for analyzing RNAseq, ChIp-Seq data. `SE` class is also used in R packages for analyzing microarrays, flow cytometry, proteomics, single-cell sequencing data and many more. The single-cell analysis is facilitated by [SingelCellExperiment class](https://bioconductor.org/packages/release/bioc/vignettes/SingleCellExperiment/inst/doc/intro.html) (`SCE`), which allows the user to store results of dimensionality reduction and alternative experiments. Alternative experiments (`altExps`) can be differently processed data within the analysis workflows. 

Recently, [`TreeSummarizedExperiment`](https://www.bioconductor.org/packages/release/bioc/html/TreeSummarizedExperiment.html) (`TSE`), [`MicrobiomeExperiment`](https://github.com/FelixErnst/MicrobiomeExperiment) were developed to extend the `SE` and `SCE` class for incorporating hierarchical information (including phylogenetic tree) and reference sequences.    

The `mia` package implements tools using these classes for analysis of microbiome sequencing data.       

## Common terminologies    

`assays`     : This slot is similar to `otu_table` in `phyloseq`. In a `SummarizedExperiment`
               object multiple assays, raw counts, transformed counts can be stored. See also 
               [`MultiAssayExperiment`](https://bioconductor.org/packages/release/bioc/html/MultiAssayExperiment.html) for storing data from multiple `assays` such as RNASeq, Proteomics, etc.       
`rowData`    : This slot is similar to `tax_table` in `phyloseq` to store taxonomic information.     
`colData`    : This slot is similar to `sample_data` in `phyloseq` to store information related to samples.    
`rowTree`    : This slot is similar to `phy_tree` in `phyloseq` to store phylogenetic tree.     

In this book, you will come across terms like `FeatureIDs` and `SampleIDs`.   
`FeatureIDs` : These are basically OTU/ASV ids which are row names in `assays` and `rowData`.    
`SampleIDs`  : As the name suggests, these are sample ids which are column names in `assays` and row names in `colData`.   


## Retrieving data elements  

Extract specific elements from `TreeSummarizedExperiment` and `MicrobiomeExperiment` object.    

```{r libs, message=FALSE}
library(mia)
library(dplyr)
library(ggplot2)
library(tibble)
```

Example data   
```{r data}

data("GlobalPatterns")
me <- GlobalPatterns 
```

Create a relative abundance assay
```{r rel-ab}
me <- relAbundanceCounts(GlobalPatterns)
me
```

Above there are now two `assays`  
1] counts  
2] relabundance  

## Extract specific elements   

### Assays  
`Assay` slots hold the counts and transformed data for `FeatureIDs` and these can be extracted as follows:  
Extract count abundance data.
```{r assay-1}

me_counts <- assay(me, "counts")
me_counts[1:5,1:7]

```
Extract relative abundance data.  
```{r assay-2}
me_reab <- assay(me, "relabundance")
me_reab[1:5,1:7]
```


### colData  
The sample information can be retrieved by accessing the `colData` as a data.frame.   
```{r coldata}
me_sample_data <- colData(me) %>% 
    as.data.frame()
# show select row and columns
me_sample_data[1:5,1:5]
```


### rowData  
The taxonomic classification of `FeatureIds` can be retrieved by accessing the `rowData` as a data.frame.   
```{r rowdata}

me_row_data <- rowData(me) %>% 
    as.data.frame()
# show select row and columns
me_row_data[1:5,1:5]
```


### rowTree  
The phylogenetic tree for `FeatureIds` can be retrieved by accessing the `rowTree` which is a `phylo` object.       
```{r rowtree}
me_row_tree <- rowTree(me) 
me_row_tree
```

Check link between rownames `FeatureIds`.  
```{r rowlink}
# extract the linkData
# on rows
rowL <- rowLinks(x = me)
```

## Library size   

The total counts/sample can be calculated using the `colSums`.    

```{r lib-size}

reads_sample <- colSums(assay(me, "counts")) 
# add it to colData
colData(me)$reads_sample <- reads_sample

```

Visualize library size 
```{r viz-lib-size, fig.width=8, fig.height=4}
me_sample_data <- colData(me) %>% 
    as.data.frame() %>% 
    rownames_to_column("SampleId")

ggplot(me_sample_data, aes(reads_sample, SampleId)) +
    geom_col(aes(fill=SampleType)) +
    theme_bw() + # prettify plot
    theme(axis.text = element_text(size = 10), 
          axis.line.x = element_line(color = "#242424"), 
          axis.line.y = element_line(color = "#242424"), 
          panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.border = element_rect(colour = "#242424"), 
          legend.key = element_blank(), legend.text = element_text(color = "#353535"), 
          legend.background = element_rect(colour = NA, fill = NA))

```
  
## Agglomerate  

Agglomerate at a specific taxonomic rank. If multiple assays (counts and relabundance) exists, both will be agglomerated.  
```{r agglomerate-1}
me_fam <- agglomerateByRank(me, rank = "Family",
                        agglomerateTree = TRUE)

print(me_fam)
```

```{r agglomerate-2}
me_fam_reab <- assay(me_fam, "relabundance")
me_fam_reab[1:5,1:7]
```
  
```{r agglomerate-3}
me_fam_reab <- assay(me_fam, "counts")
me_fam_reab[1:5,1:7]
```

These newly created data can also be kept in `altExp` a feature provided by `SingleCellExperiment`.    

```{r altExp-1}
altExp(me, "family") <- me_fam
```
`altExpNames` now consists of `family` level data. This can be extended to use any level present in `r taxonomyRanks(me)`.   

## Get unique  
Get which Phyla are present.  
```{r unique-1}
head(unique(rowData(me)[,"Phylum"]))
```

## Pick specific  
Retrieving of specific elements are required for specific analysis. For instance, extracting abundances for a specific taxa in all samples or all taxa in one sample.  

### Abundances of all taxa in specific sample 
```{r pick-sample}

taxa.abund.cc1 <- getAbundanceSample(me, 
                                     sample_id = "CC1",
                                     abund_values = "counts")

taxa.abund.cc1[1:10]

```

### Abundances of specific taxa in all samples   

```{r pick-feature}

taxa.abundances <- getAbundanceFeature(me, 
                                      feature_id = "255340",
                                       abund_values = "counts")
taxa.abundances[1:10]
```

## Join  

Joining `assay` and `rowData` in one data frame for exploring `featureIds` and their taxonomic identities.   

```{r join-1}

me_reab <- assay(me, "relabundance") %>% 
    as.data.frame() %>% 
    rownames_to_column("FeatureID")

me_joined <- rowData(me) %>% 
    as.data.frame() %>% 
    rownames_to_column("FeatureID") %>% 
    left_join(me_reab) 

me_joined[1:3,1:8]

```


### Convert to long data.frame   

For several custom analysis and visualization packages such as those from the `tidyverse` the `SE` data can be converted to long data.frame format with `meltAssay`.    

```{r ldf-1}

molten_se <- meltAssay(me,
                       add_row_data = TRUE,
                       add_col_data = TRUE,
                       abund_values = "relabundance")

```


## Get top taxa and taxonomy   

### Features  

The `getTopTaxa` can be used for identifying top taxa in the data.   
```{r top-feature-taxo}

top_features <- getTopTaxa(me, method="median", top=10)
tax_data <- rowData(me)[top_features,taxonomyRanks(me)]
tax_data %>% as.data.frame()

```

